<div class="panel panel-default komet-no-margins komet-panel" id="komet_viewer_<%= @viewer_id %>" data-komet-viewer-id="<%= @viewer_id %>">
    <!-- DO NOT PUT ANYTHING ABOVE THE KOMET VIEWER DIV - IT WILL BREAK WINDOWING WHEN CLOSING VIEWERS AND BE REPEATED EVERY TIME NEW CONTENT IS LOADED TO INLINE VIEWER -->

    <div class="panel-heading">

        <span class="panel-title komet-section-title">

            <button type="button" class="komet-link-button" onclick="WindowManager.toggleViewerLinkage('<%= @viewer_id %>', WindowManager.getLinkedViewerID() != '<%= @viewer_id %>');" title="Viewer linked to Mapping Tree. Click to unlink.">
                <span id="komet_mapping_panel_tree_link_<%= @viewer_id %>" class="fa fa-chain-broken"></span>
            </button>

            <button type="button" class="komet-link-button" id="komet_mapping_panel_tree_show_<%= @viewer_id %>" onclick="WindowManager.viewers[<%= @viewer_id %>].showInMappingTree();" title="Show in Mapping Tree">
                <span class="fa fa-tree"></span>
            </button>
            
            <%= @viewer_title %>
        </span>

        <div class="komet-panel-tools">

            <div class="komet-panel-tools-control" style="display: none">
                <%= label_tag "komet_mapping_overview_page_size_#{@viewer_id}", 'Page Size:', style: 'display: none' %>
                <%= select_tag "komet_mapping_overview_page_size_#{@viewer_id}", options_for_select([['25'], ['50'], ['100'], ['250'], ['500'], ['1000']], '25'), style: 'display: none'  %>
            </div>

            <button type="button" id="komet_mapping_overview_sets_refresh_<%= @viewer_id %>" class="komet-link-button komet-panel-tools-control" onclick="WindowManager.viewers[<%= @viewer_id %>].loadOverviewSetsGrid();" title="Reload Mapping Set Grid">
                <div title="Reload Mapping Set Grid" class="fa fa-refresh"></div>
            </button>

            <div class="komet-panel-tools-control">
                <label for="komet_mapping_show_stamp_<%= @viewer_id %>">Show STAMP</label>
                <input type="checkbox" id="komet_mapping_show_stamp_<%= @viewer_id %>" onclick="WindowManager.viewers[<%= @viewer_id %>].toggleSTAMP();" value="true">
            </div>

            <div class="komet-panel-tools-control">
                <div class="btn-group" data-toggle="buttons">
                    <label class="btn btn-default" for="komet_mapping_state_active_<%= @viewer_id %>">
                        <input type="radio" name="komet_mapping_states_to_view" id="komet_mapping_state_active_<%= @viewer_id %>" value="active" autocomplete="off" title="Show Only Active Concepts"> Active
                    </label>
                    <label class="btn btn-default" for="komet_mapping_state_inactive_<%= @viewer_id %>">
                        <input type="radio" name="komet_mapping_states_to_view" id="komet_mapping_state_inactive_<%= @viewer_id %>" value="inactive" autocomplete="off" title="Show Only Inactive Concepts"> Inactive
                    </label>
                    <label class="btn btn-default" for="komet_mapping_state_both_<%= @viewer_id %>">
                        <input type="radio" name="komet_mapping_states_to_view" id="komet_mapping_state_both_<%= @viewer_id %>" value="both" autocomplete="off" title="Show Active and Inactive Concepts"> Both
                    </label>
                </div>
            </div>
            <!--<div id="komet_mapping_overview_sets_inactive_<%#= @viewer_id %>" title="Toggle Inactive Concepts" class="fa-stack small" onclick="WindowManager.viewers[<%#= @viewer_id %>].toggleOverviewInactiveConcepts();">
            <div class="fa fa-square fa-stack-2x"></div>
            <div class="fa fa-code-fork fa-stack-1x fa-inverse"></div>
        </div>-->


            <button type="button" class="komet-link-button" onclick="WindowManager.closeViewer('<%= @viewer_id %>')" title="Close Viewer">
                <div class="glyphicon glyphicon-remove"></div>
            </button>
        </div>
    </div>

    <div id="komet_mapping_viewer_body_<%= @viewer_id %>" class="komet-mapping-viewer-body panel-body"></div>

    <script>

        if (!WindowManager.viewers.hasOwnProperty('<%= @viewer_id %>') || !(WindowManager.viewers[<%= @viewer_id %>] instanceof MappingViewer)) {
            MappingModule.createViewer("<%= @viewer_id %>", "<%= @set_id %>", "<%= @mapping_action %>");
        } else {

            WindowManager.viewers[<%= @viewer_id %>].currentSetID = "<%= @set_id %>";

            if (WindowManager.getLinkedViewerID() == "<%= @viewer_id %>") {
                WindowManager.viewers["<%= @viewer_id %>"].swapLinkIcon(true);
            }
        }

        if (WindowManager.getLinkedViewerID() == "<%= @viewer_id %>" && MappingModule.tree.selectedSetID != WindowManager.viewers[<%= @viewer_id %>].currentSetID) {
            WindowManager.viewers[<%= @viewer_id %>].showInMappingTree();
        }

        var SET_LIST = 'komet_dashboard/mapping/map_set_list';
        var SET_DETAILS = 'komet_dashboard/mapping/map_set_details';
        var SET_EDITOR = 'komet_dashboard/mapping/map_set_editor';
        var ITEM_EDITOR = 'komet_dashboard/mapping/map_item_editor';

        <%
            if @mapping_action == 'set_list'
                partial = 'komet_dashboard/mapping/map_set_list'
            else
                partial = 'komet_dashboard/mapping/map_set_details'
            end
        %>

        $('#komet_mapping_viewer_body_<%= @viewer_id %>').html("<%= j(render(:partial => partial)) %>");

        $(document).ready(function () {

            var statesToView = $("#komet_viewer_<%= @viewer_id %>").find("input[name='komet_mapping_states_to_view']");

            statesToView.change(function(){

                statesToView.parent().toggleClass("btn-primary btn-default");
                MappingModule.setStatesToView("<%= @viewer_id %>", this);
            });

            statesToView.each(function(index, button){

                if (button.value == "<%= @states_to_view %>"){

                    var buttonParent = button.parentElement;

                    button.checked = true;
                    buttonParent.classList.add('btn-primary');
                    $(buttonParent).removeClass("btn-default");
                }
            });

            WindowManager.viewers[<%= @viewer_id %>].restorePanelStates();
            UIHelper.initializeContextMenus();
        });
    </script>

    <!-- DO NOT PUT ANYTHING ABOVE THE BELOW THIS LAST DIV - IT WILL GET REPEATED EVERY TIME NEW CONTENT IS LOADED TO INLINE VIEWER-->
</div>