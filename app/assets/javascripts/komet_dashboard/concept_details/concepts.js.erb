var ConceptsModule = (function () {
  var currentConceptID;
  var panelStates = {};

  function setPanelState(panelID, state, callback) {
    if (panelStates[panelID] === undefined) {
      panelStates[panelID] = [];
    }
    panelStates[panelID][0] = state;
    if (callback){
      panelStates[panelID][1] = callback;
    }
  }

  function getPanelState(panelID) {
    if(!panelStates[panelID]) {
      return false;
    }
    return panelStates[panelID][0];
  }

  function restorePanelStates() {
    for (var key in panelStates) {
      var state = panelStates[key][0];
      var callback = panelStates[key][1];
      if (state) {
        UIHelper.togglePanelDetails(key, callback);
      }
    }
  }

  function subscribeToTaxonomyTree() {

    // listen for the onChange event broadcast by any of the taxonomy trees.
    $.subscribe(KometChannels.Taxonomy.taxonomyTreeNodeSelectedChannel, function (e, conceptID) {

      currentConceptID = conceptID;

      loadConceptTabs()
    });
  }

  function subscribeToSearch() {

    // listen for the onChange event broadcast by selecting a search result.
    $.subscribe(KometChannels.Taxonomy.taxonomySearchResultSelectedChannel, function (e, conceptID) {

      currentConceptID = conceptID;

      TaxonomyModule.selectedTreeNode = currentConceptID;

      loadConceptTabs();
    });
  }

  function loadConceptTabs() {

    // the path to a javascript partial file that will re-render all the appropriate partials once the ajax call returns
    var partial = 'komet_dashboard/concept_detail/load_tabs';

    // make an ajax call to get the concept for the current concept and pass it the currently selected concept id and the name of a partial file to render
    $.get(gon.routes.taxonomy_get_concept_information_path, {concept_id: currentConceptID, partial: partial}, function (data) {
    });
  }

  function getCurrentConceptId() {
    return currentConceptID;
  }

  function init() {
    subscribeToTaxonomyTree();
    subscribeToSearch();
  }

  return {
    initialize: init,
    getCurrentConceptId: getCurrentConceptId,
    setPanelState : setPanelState,
    getPanelState : getPanelState,
    restorePanelStates : restorePanelStates,
  };

})();
